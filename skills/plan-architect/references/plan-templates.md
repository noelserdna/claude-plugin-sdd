# Plan Templates — Output Artifact Formats

> Reference document for plan-architect Phase 5 (Plan Generation) and Phase 4 (Architecture Design).
> Contains canonical templates for all output artifacts.

---

## Template: PLAN.md (Master Implementation Plan)

```markdown
# Implementation Plan — {System Name}

> Generated by plan-architect from spec v{version}
> Date: {YYYY-MM-DD}
> Mode: {Global | Per-FASE}

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | {date} | Initial plan generation |

---

## 1. Executive Summary

{2-3 sentences: what this plan covers, key architectural decisions, implementation approach}

## 2. Technical Context

### 2.1 Platform & Runtime

| Aspect | Decision | Reference |
|--------|----------|-----------|
| Runtime | {e.g., Cloudflare Workers} | {ADR-xxx} |
| Language | {e.g., TypeScript 5.x} | {ADR-xxx} |
| HTTP Framework | {e.g., Hono} | {ADR-xxx} |
| Build Tool | {e.g., Wrangler} | {ADR-xxx} |

### 2.2 Storage

| Store | Technology | Purpose | Reference |
|-------|-----------|---------|-----------|
| Primary DB | {e.g., Cloudflare D1} | Relational data | {ADR-xxx} |
| Object Store | {e.g., Cloudflare R2} | PDF/document storage | {ADR-xxx} |
| Cache/KV | {e.g., Cloudflare KV} | Rate limiting, sessions | {ADR-xxx} |

### 2.3 External Integrations

| System | Protocol | Purpose | Reference |
|--------|----------|---------|-----------|
| {e.g., Anthropic API} | {HTTPS/REST} | {LLM extraction} | {contract ref} |

### 2.4 Key Constraints

| Constraint | Value | Source |
|------------|-------|--------|
| {e.g., Max PDF size} | {50 MB} | {nfr/LIMITS.md} |
| {e.g., Extraction timeout} | {360s} | {RN-181} |

## 3. Component Decomposition

### 3.1 Module Map

| Module | Bounded Context | Responsibility | Key Specs |
|--------|----------------|---------------|-----------|
| {e.g., extraction} | Extraction | PDF processing pipeline | UC-001..UC-005 |
| {e.g., cv-analysis} | CV Analysis | 24-dimension analysis | UC-010..UC-015 |

### 3.2 Module Dependencies

```
{ASCII dependency diagram}
extraction → cv-analysis → matching
                         ↘ gdpr
auth ──────→ all modules
```

### 3.3 Shared Components

| Component | Used By | Purpose |
|-----------|---------|---------|
| {e.g., auth-middleware} | All modules | JWT validation, RBAC |
| {e.g., tenant-context} | All modules | Multi-tenant isolation |
| {e.g., error-handler} | All modules | Consistent error responses |

## 4. Cross-FASE Concerns

### 4.1 Authentication & Authorization

{How auth is implemented across phases, when RBAC is introduced}

### 4.2 Multi-Tenant Isolation

{Data isolation strategy, how org_id propagates}

### 4.3 Error Handling Pattern

{Consistent error response format, error codes, logging}

### 4.4 Observability

{Logging format, metrics, tracing strategy}

## 5. Risk Assessment

| # | Risk | Impact | Probability | Mitigation |
|---|------|--------|-------------|------------|
| R1 | {description} | {H/M/L} | {H/M/L} | {strategy} |

## 6. Developer Quickstart

### 6.1 Prerequisites

```bash
# Required tools
{tool installation commands}
```

### 6.2 Setup

```bash
# Clone and setup
{setup commands}
```

### 6.3 Development Workflow

```bash
# Build
{build commands}

# Test
{test commands}

# Deploy (local/dev)
{deploy commands}
```

## 7. Validation & Traceability

### 7.1 UC Coverage

| UC | Module | FASE | Plan Section |
|----|--------|------|-------------|
| UC-001 | extraction | FASE-1 | 3.1 |

### 7.2 ADR Compliance

| ADR | Reflected In | Status |
|-----|-------------|--------|
| ADR-001 | Section 2.1 | ✅ |

### 7.3 NFR Strategy Coverage

| NFR | Strategy | Plan Section |
|-----|----------|-------------|
| {nfr ref} | {strategy summary} | {section} |

### 7.4 Invariant Enforcement

| Invariant | Enforcement Mechanism | Module |
|-----------|----------------------|--------|
| INV-xxx | {e.g., DB constraint + middleware check} | {module} |

---

> Generated by plan-architect | Spec v{version} | {date}
```

---

## Template: ARCHITECTURE.md

```markdown
# Architecture — {System Name}

> Generated by plan-architect from spec v{version}
> Date: {YYYY-MM-DD}

## 1. C4 Model

### 1.1 System Context (Level 1)

```
{ASCII diagram showing system + actors + external systems}

[Actor] ──→ [System] ──→ [External System]
```

**Actors:**
| Actor | Type | Interaction |
|-------|------|------------|
| {actor} | {Person/System} | {description} |

**External Systems:**
| System | Protocol | Data Exchanged |
|--------|----------|---------------|
| {system} | {protocol} | {data} |

### 1.2 Container Diagram (Level 2)

```
{ASCII diagram showing containers within the system}

[Web App] ──→ [API Worker] ──→ [D1 Database]
                            ──→ [R2 Storage]
                            ──→ [KV Cache]
```

**Containers:**
| Container | Technology | Purpose |
|-----------|-----------|---------|
| {container} | {tech} | {purpose} |

### 1.3 Component Diagram (Level 3)

{Per bounded context / module}

```
[API Worker]
├── auth/
│   ├── jwt-validator
│   ├── rbac-enforcer
│   └── tenant-resolver
├── extraction/
│   ├── upload-handler
│   ├── extraction-orchestrator
│   └── llm-client
└── ...
```

**Components:**
| Component | Module | Responsibility | Key Interfaces |
|-----------|--------|---------------|----------------|
| {component} | {module} | {responsibility} | {interfaces} |

## 2. Deployment View

### 2.1 Infrastructure Topology

```
{ASCII diagram of deployment topology}

[CDN/Edge] → [Workers] → [D1] + [R2] + [KV]
                       → [External APIs]
```

### 2.2 Environment Map

| Environment | Purpose | Infrastructure | URL Pattern |
|-------------|---------|---------------|-------------|
| Development | Local dev | Miniflare/Wrangler dev | localhost:8787 |
| Staging | Pre-production | Workers (staging) | staging.{domain} |
| Production | Live | Workers (production) | api.{domain} |

### 2.3 Deployment Pipeline

```
Code → Lint → Test → Build → Deploy Staging → Smoke Tests → Deploy Prod
```

## 3. Physical Data Model

### 3.1 Database Schema

{Per entity from domain/02-ENTITIES.md}

```sql
-- {EntityName}
CREATE TABLE {table_name} (
  id TEXT PRIMARY KEY,       -- {ID strategy}
  org_id TEXT NOT NULL,      -- Multi-tenant isolation
  {columns from entity fields}
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE INDEX idx_{table}_org ON {table_name}(org_id);
```

### 3.2 Storage Map

| Data Type | Store | Format | Retention |
|-----------|-------|--------|-----------|
| {e.g., PDF originals} | {R2} | {binary} | {per policy} |
| {e.g., Extracted markdown} | {R2} | {text/markdown} | {per policy} |
| {e.g., Rate limit counters} | {KV} | {JSON} | {TTL-based} |

### 3.3 Migration Strategy

{How schema changes are managed: versioned migrations, D1 migrations API, etc.}

## 4. Integration Map

### 4.1 External System Connections

| External System | Direction | Protocol | Auth | Error Handling |
|----------------|-----------|----------|------|---------------|
| {system} | {inbound/outbound} | {REST/webhook} | {auth type} | {strategy} |

### 4.2 Integration Patterns

| Pattern | Where Used | Description |
|---------|-----------|-------------|
| {e.g., Circuit Breaker} | LLM calls | {description} |
| {e.g., Retry with backoff} | External APIs | {description} |

## 5. Security Architecture

### 5.1 Authentication Flow

```
{ASCII diagram of auth flow}
```

### 5.2 Authorization Model

```
{RBAC enforcement diagram}
Request → JWT Validate → Tenant Resolve → RBAC Check → Handler
```

### 5.3 Data Protection

| Data Class | At Rest | In Transit | Access Control |
|-----------|---------|-----------|---------------|
| PII | {encryption} | {TLS} | {RBAC rules} |
| Documents | {encryption} | {TLS} | {RBAC rules} |

---

> Generated by plan-architect | Spec v{version} | {date}
```

---

## Template: RESEARCH.md

```markdown
# Technical Research — {System Name}

> Generated by plan-architect Phase 3 (Technical Research)
> Date: {YYYY-MM-DD}

## Research Items

{One section per NEEDS_RESEARCH item from Phase 2}

### RES-{NNN}: {Title}

**Category:** {CL-xxx}
**Question:** {Original clarify question}
**Status:** {Decided | Open | Deferred}

#### Alternatives Evaluated

| Alternative | Pros | Cons | Fit Score |
|------------|------|------|-----------|
| {option 1} | {pros} | {cons} | {1-5} |
| {option 2} | {pros} | {cons} | {1-5} |

#### Decision

**Selected:** {chosen alternative}
**Rationale:** {why this was chosen}
**Trade-offs accepted:** {what we give up}

#### References

- {URL or document reference}

---

## Flagged ADR Drafts

{ADR skeletons for decisions that should be formalized}

### Draft ADR-{NNN}: {Title}

**Status:** Draft (pending formalization)
**Context:** {from research}
**Decision:** {from research}
**Consequences:** {from research}
**Action:** Formalize as ADR-{NNN} in spec/adr/

---

> Generated by plan-architect | {date}
```

---

## Template: CLARIFY-LOG.md

```markdown
# Clarify Log — {System Name}

> Interactive clarification sessions for implementation planning.
> Generated by plan-architect Phase 2.

## Coverage Summary

| Category | Status | Evidence |
|----------|--------|----------|
| CL-TECH | {Resolved/Partial/Missing} | {reference} |
| CL-ARCH | {Resolved/Partial/Missing} | {reference} |
| CL-DATA | {Resolved/Partial/Missing} | {reference} |
| CL-INTEG | {Resolved/Partial/Missing} | {reference} |
| CL-PERF | {Resolved/Partial/Missing} | {reference} |
| CL-SEC | {Resolved/Partial/Missing} | {reference} |
| CL-CICD | {Resolved/Partial/Missing} | {reference} |
| CL-OBS | {Resolved/Partial/Missing} | {reference} |
| CL-TEST | {Resolved/Partial/Missing} | {reference} |
| CL-COST | {Resolved/Partial/Missing} | {reference} |

**Resolved:** {N}/10 | **Partial:** {N}/10 | **Missing:** {N}/10

## Skipped Categories

| Category | Reason | Evidence |
|----------|--------|----------|
| {CL-xxx} | {Resolved by ADR-xxx} | {ADR reference} |

---

## Session {YYYY-MM-DD}

### Q1: {CL-xxx-NNN} — {Short Title}

**Question:** {Full question text}

**Options presented:**
| Opción | Descripción |
|--------|-------------|
| {option 1} (Recomendado) | {description} |
| {option 2} | {description} |
| {option 3} | {description} |

**Answer:** {User's selected option or custom answer}
**Rationale:** {Why this was chosen, if provided}
**Impact:** {What this decision affects}
**Needs ADR:** {Yes/No} → {ADR-xxx if yes}
**Needs Research:** {Yes/No} → {RES-xxx if yes}

---

### Q2: ...

{Same format}

---

### Session Summary

- **Questions asked:** {N}
- **Decisions made:** {N}
- **Deferred:** {N}
- **New ADRs needed:** {list}
- **Research needed:** {list}
- **Early termination:** {Yes/No — reason}

---

> Generated by plan-architect | {date}
```

---

## Template: PLAN-FASE-{N}.md (Per-FASE Plan)

```markdown
# Implementation Plan — FASE-{N}: {FASE Title}

> Generated by plan-architect from spec v{version}
> Date: {YYYY-MM-DD}
> Dependencies: {FASE-X, FASE-Y}

## 1. FASE Overview

**Objective:** {What this FASE delivers}
**Scope:** {Bounded contexts / modules involved}
**Depends on:** {Previous FASEs that must be complete}
**Enables:** {Subsequent FASEs that depend on this}

## 2. Specs to Implement

| Spec | Type | Key Decisions |
|------|------|--------------|
| {spec path} | {UC/ADR/INV/WF} | {implementation notes} |

## 3. Technical Decisions (FASE-Specific)

### 3.1 {Decision Title}

**Context:** {Why this decision matters for this FASE}
**Decision:** {What was decided}
**Reference:** {ADR-xxx or CLARIFY-LOG entry}

## 4. Component Implementation

### 4.1 {Component Name}

**Module:** {module name}
**Responsibility:** {what it does}
**Key interfaces:**

```typescript
// Interface sketch (derived from contracts)
interface {InterfaceName} {
  {method}({params}): Promise<{return}>;
}
```

**Implementation notes:**
- {note 1}
- {note 2}

### 4.2 {Next Component}

{Same format}

## 5. API Implementation Notes

{Per API endpoint in this FASE}

| Endpoint | Method | Handler | Middleware | Notes |
|----------|--------|---------|-----------|-------|
| {path} | {GET/POST/...} | {handler} | {auth, validation} | {notes} |

## 6. Data Changes

### 6.1 New Tables/Schemas

```sql
-- {table description}
CREATE TABLE {table_name} (
  {columns}
);
```

### 6.2 Migrations

| Migration | Description | Reversible |
|-----------|-------------|-----------|
| {NNN}_{name} | {description} | {Yes/No} |

## 7. Test Strategy

### 7.1 Unit Tests

| Component | Test Focus | Estimated Count |
|-----------|-----------|----------------|
| {component} | {what to test} | {N} |

### 7.2 Integration Tests

| Scenario | Components | Setup Required |
|----------|-----------|---------------|
| {scenario} | {components} | {setup} |

### 7.3 BDD Scenarios

| BDD Spec | Scenarios | Priority |
|----------|-----------|----------|
| {spec ref} | {N scenarios} | {P1/P2/P3} |

### 7.4 Test Coverage Map (Source → Test)

| Source File | Type | Test File | Priority |
|------------|------|-----------|----------|
| {source_path} | {logic/entity/service/state-machine} | {test_path} | {HIGH/MEDIUM/LOW} |

**Exclusions (no unit test needed):**

| File | Reason |
|------|--------|
| {file_path} | {infrastructure wrapper / enum constant / tested via integration or E2E} |

> Every source file with testable logic MUST appear in this table or in Exclusions.
> This map drives task generation: each row becomes a test task.

## 8. Dependencies on Shared Components

| Component | From FASE | Required For |
|-----------|-----------|-------------|
| {component} | FASE-{X} | {what needs it} |

## 9. Acceptance Criteria

- [ ] {criterion 1 — maps to UC/INV}
- [ ] {criterion 2}
- [ ] All BDD scenarios pass
- [ ] No new security findings
- [ ] Performance targets met: {specific targets}

---

> Generated by plan-architect | Spec v{version} | {date}
```

---

## Format Conventions

### Consistent Across All Templates

1. **Header**: Always includes system name, spec version, generation date
2. **Footer**: Always includes generator attribution
3. **Tables**: Use markdown tables for structured data
4. **Code blocks**: Use fenced code blocks with language tags
5. **ASCII diagrams**: Preferred over external diagram tools (portable, version-controllable)
6. **References**: Always link to source spec/ADR/INV by ID
7. **Status indicators**: Use ✅ ❌ for boolean, {H/M/L} for severity/probability

### Naming Conventions

| Artifact | File Name | Location |
|----------|-----------|----------|
| Master Plan | `PLAN.md` | `plan/` |
| Architecture | `ARCHITECTURE.md` | `plan/` |
| Clarify Log | `CLARIFY-LOG.md` | `plan/` |
| Research | `RESEARCH.md` | `plan/` |
| Per-FASE Plan | `PLAN-FASE-{N}.md` | `plan/fase-plans/` |

### Incremental Updates

When updating existing artifacts:
1. Add new version entry to Document History table
2. Mark changed sections with `<!-- updated {date} -->`
3. Do NOT delete previous content — mark as superseded if needed
4. Update Coverage/Traceability tables to reflect changes
